% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/tr_sens_spec.R
\name{tr_sensitivity}
\alias{tr_sensitivity}
\alias{tr_tpr}
\title{Estimate Transportable Sensitivity in the Target Population}
\usage{
tr_sensitivity(
  predictions,
  outcomes,
  treatment = NULL,
  source,
  covariates,
  threshold = 0.5,
  treatment_level = NULL,
  analysis = c("transport", "joint"),
  estimator = c("dr", "om", "ipw", "naive"),
  selection_model = NULL,
  propensity_model = NULL,
  outcome_model = NULL,
  se_method = c("none", "bootstrap", "influence"),
  n_boot = 200,
  conf_level = 0.95,
  stratified_boot = TRUE,
  cross_fit = FALSE,
  n_folds = 5,
  ps_trim = NULL,
  parallel = FALSE,
  ncores = NULL,
  ...
)

tr_tpr(
  predictions,
  outcomes,
  treatment = NULL,
  source,
  covariates,
  threshold = 0.5,
  treatment_level = NULL,
  analysis = c("transport", "joint"),
  estimator = c("dr", "om", "ipw", "naive"),
  selection_model = NULL,
  propensity_model = NULL,
  outcome_model = NULL,
  se_method = c("none", "bootstrap", "influence"),
  n_boot = 200,
  conf_level = 0.95,
  stratified_boot = TRUE,
  cross_fit = FALSE,
  n_folds = 5,
  ps_trim = NULL,
  parallel = FALSE,
  ncores = NULL,
  ...
)
}
\arguments{
\item{predictions}{Numeric vector of model predictions.}

\item{outcomes}{Numeric vector of observed outcomes.}

\item{treatment}{Numeric vector of treatment indicators (0/1), or \code{NULL} for
factual prediction model transportability (no treatment/intervention).
When \code{NULL}, only the selection model is used for weighting.}

\item{source}{Numeric vector of population indicators (1=source/RCT, 0=target).}

\item{covariates}{A matrix or data frame of baseline covariates.}

\item{threshold}{Numeric vector of classification thresholds. Predictions
above this value are classified as positive. Can be a single value or
a vector for computing sensitivity at multiple thresholds simultaneously.
Default is 0.5.}

\item{treatment_level}{The treatment level of interest (default: \code{NULL}).
Required when \code{treatment} is provided; should be \code{NULL} when \code{treatment}
is \code{NULL} (factual mode).}

\item{analysis}{Character string specifying the type of analysis:
\itemize{
\item \code{"transport"}: Use source outcomes for target estimation (default)
\item \code{"joint"}: Pool source and target data
}}

\item{estimator}{Character string specifying the estimator:
\itemize{
\item \code{"naive"}: Naive estimator (biased)
\item \code{"om"}: Outcome model estimator
\item \code{"ipw"}: Inverse probability weighting estimator
\item \code{"dr"}: Doubly robust estimator (default)
}}

\item{selection_model}{Optional fitted selection model for P(S=0|X). If NULL,
a logistic regression model is fit using the covariates.}

\item{propensity_model}{Optional fitted propensity score model for P(A=1|X,S=1).
If NULL, a logistic regression model is fit using source data.}

\item{outcome_model}{Optional fitted outcome model for E[L(Y,g)|X,A,S].
If NULL, a regression model is fit using the relevant data. For binary
outcomes, this should be a model for E[Y|X,A] (binomial family). For
continuous outcomes, this should be a model for E[L|X,A] (gaussian family).}

\item{se_method}{Method for standard error estimation:
\itemize{
\item \code{"bootstrap"}: Bootstrap standard errors (default)
\item \code{"influence"}: Influence function-based standard errors
\item \code{"none"}: No standard error estimation
}}

\item{n_boot}{Number of bootstrap replications (default: 500).}

\item{conf_level}{Confidence level for intervals (default: 0.95).}

\item{stratified_boot}{Logical indicating whether to use stratified bootstrap
that preserves the source/target ratio (default: TRUE). Recommended for
transportability analysis.}

\item{cross_fit}{Logical indicating whether to use cross-fitting for
nuisance model estimation (default: FALSE).}

\item{n_folds}{Number of folds for cross-fitting (default: 5).}

\item{ps_trim}{Propensity score trimming specification. Controls how
extreme propensity scores are handled. Can be:
\itemize{
\item \code{NULL} (default): Uses absolute bounds \code{c(0.01, 0.99)}
\item \code{"none"}: No trimming applied
\item \code{"quantile"}: Quantile-based trimming with default \code{c(0.01, 0.99)}
\item \code{"absolute"}: Explicit absolute bounds with default \code{c(0.01, 0.99)}
\item A numeric vector of length 2: \code{c(lower, upper)} absolute bounds
\item A single numeric: Symmetric bounds \code{c(x, 1-x)}
\item A list with \code{method} ("absolute"/"quantile"/"none") and \code{bounds}
}}

\item{parallel}{Logical indicating whether to use parallel processing
for bootstrap (default: FALSE).}

\item{ncores}{Number of cores for parallel processing (default: NULL,
which uses all available cores minus one).}

\item{...}{Additional arguments passed to internal functions.}
}
\value{
An object of class \code{c("tr_sensitivity", "tr_performance")} containing:
\item{estimate}{Point estimate(s) of transportable sensitivity}
\item{se}{Standard error(s) (if computed)}
\item{ci_lower}{Lower confidence interval bound(s)}
\item{ci_upper}{Upper confidence interval bound(s)}
\item{threshold}{Threshold value(s) used}
\item{estimator}{Estimator used}
\item{analysis}{Analysis type}
\item{naive_estimate}{Naive sensitivity for comparison}
\item{n_target}{Number of target observations}
\item{n_source}{Number of source observations}
\item{treatment_level}{Treatment level (NULL for factual mode)}
}
\description{
Estimates the sensitivity (true positive rate) of a binary classifier at
one or more thresholds in a target population using data transported from
a source population. Supports both \strong{counterfactual} (under hypothetical
intervention) and \strong{factual} (observational) prediction model
transportability.
}
\details{
Sensitivity (also known as true positive rate or recall) is defined as:
\deqn{Sensitivity(c) = P(\hat{Y} > c | Y = 1)}
\subsection{Counterfactual Mode (treatment provided)}{

When \code{treatment} is specified, estimates sensitivity for counterfactual
outcomes under a hypothetical intervention. Requires selection, propensity,
and outcome models.
}

\subsection{Factual Mode (treatment = NULL)}{

When \code{treatment} is \code{NULL}, estimates sensitivity for observed outcomes in
the target population using only the selection model for inverse-odds
weighting. This is appropriate for factual prediction model
transportability.
}

\subsection{Estimators}{

\strong{Outcome Model (OM) Estimator}:
\deqn{\hat{\psi}_{sens,om} = \frac{\sum_i I(S_i=0) I(\hat{h}(X_i) > c) \hat{m}(X_i)}{\sum_i I(S_i=0) \hat{m}(X_i)}}
where \eqn{\hat{m}(X) \approx P(Y=1|X, R=1)}.

\strong{IPW Estimator}:
\deqn{\hat{\psi}_{sens,ipw} = \frac{\sum_i I(\hat{h}(X_i) > c, Y_i=1, R_i=1) \hat{w}(X_i)}{\sum_i I(Y_i=1, R_i=1) \hat{w}(X_i)}}
where \eqn{\hat{w}(X) \approx P(R=0|X)/P(R=1|X)}.

\strong{Doubly Robust (DR) Estimator}: Combines OM and IPW for protection against
misspecification of either model.
}
}
\examples{
# Generate example data with source (RCT) and target populations
set.seed(123)
n <- 1000
x <- rnorm(n)
s <- rbinom(n, 1, plogis(0.5 - 0.3 * x))
a <- ifelse(s == 1, rbinom(n, 1, 0.5), rbinom(n, 1, plogis(-0.5 + 0.5 * x)))
y <- rbinom(n, 1, plogis(-1 + x - 0.5 * a))
pred <- plogis(-1 + 0.8 * x)

# Estimate transportable sensitivity at default threshold (0.5)
result <- tr_sensitivity(
  predictions = pred,
  outcomes = y,
  treatment = a,
  source = s,
  covariates = data.frame(x = x),
  treatment_level = 0,
  estimator = "dr",
  se_method = "none"
)
print(result)

# Estimate at multiple thresholds
result_multi <- tr_sensitivity(
  predictions = pred,
  outcomes = y,
  treatment = a,
  source = s,
  covariates = data.frame(x = x),
  threshold = c(0.3, 0.5, 0.7),
  se_method = "none"
)
print(result_multi)
}
\references{
Steingrimsson, J. A., et al. (2023). "Transporting a Prediction Model for
Use in a New Target Population." \emph{American Journal of Epidemiology},
192(2), 296-304. \doi{10.1093/aje/kwac128}

Steingrimsson, J. A., Wen, L., Voter, S., & Dahabreh, I. J. (2024).
"Interpretable meta-analysis of model or marker performance."
\emph{arXiv preprint arXiv:2409.13458}.

Coston, A., Mishler, A., Kennedy, E. H., & Chouldechova, A. (2020).
"Counterfactual risk assessments, evaluation, and fairness."
\emph{Proceedings of the 2020 Conference on Fairness, Accountability, and
Transparency}, 582-593.
}
\seealso{
\code{\link[=tr_specificity]{tr_specificity()}}, \code{\link[=tr_fpr]{tr_fpr()}}, \code{\link[=tr_auc]{tr_auc()}}
}
