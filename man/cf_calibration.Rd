% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/cf_calibration.R
\name{cf_calibration}
\alias{cf_calibration}
\title{Estimate Counterfactual Calibration Curve}
\usage{
cf_calibration(
  predictions,
  outcomes,
  treatment,
  covariates,
  treatment_level = 0,
  estimator = c("dr", "ipw", "cl"),
  propensity_model = NULL,
  outcome_model = NULL,
  smoother = c("loess", "binned"),
  n_bins = 10,
  span = 0.75,
  se_method = c("none", "bootstrap"),
  n_boot = 200,
  conf_level = 0.95,
  ps_trim = NULL,
  ...
)
}
\arguments{
\item{predictions}{Numeric vector of model predictions.}

\item{outcomes}{Numeric vector of observed outcomes.}

\item{treatment}{Numeric vector of treatment indicators (0/1).}

\item{covariates}{A matrix or data frame of baseline covariates (confounders).}

\item{treatment_level}{The counterfactual treatment level (default: 0).}

\item{estimator}{Character string specifying the estimator:
\itemize{
\item \code{"naive"}: Naive estimator (biased)
\item \code{"cl"}: Conditional loss estimator
\item \code{"ipw"}: Inverse probability weighting estimator
\item \code{"dr"}: Doubly robust estimator (default)
}}

\item{propensity_model}{Optional fitted propensity score model. If NULL,
a logistic regression model is fit using the covariates.}

\item{outcome_model}{Optional fitted outcome model. If NULL, a regression
model is fit using the covariates among treated/untreated. For binary
outcomes, this should be a model for E[Y|X,A] (binomial family). For
continuous outcomes, this should be a model for E[L|X,A] (gaussian family).}

\item{smoother}{Smoothing method for the calibration curve:
\itemize{
\item \code{"loess"}: Local polynomial regression (default)
\item \code{"binned"}: Binned calibration
}}

\item{n_bins}{Number of bins for binned calibration (default: 10).}

\item{span}{Span parameter for LOESS smoothing (default: 0.75).}

\item{se_method}{Method for standard error estimation:
\itemize{
\item \code{"none"}: No standard errors (default, fastest)
\item \code{"bootstrap"}: Bootstrap standard errors
}}

\item{n_boot}{Number of bootstrap replications (default: 200).}

\item{conf_level}{Confidence level for intervals (default: 0.95).}

\item{ps_trim}{Propensity score trimming specification. Controls how
extreme propensity scores are handled. Can be:
\itemize{
\item \code{NULL} (default): Uses absolute bounds \code{c(0.01, 0.99)}
\item \code{"none"}: No trimming applied
\item \code{"quantile"}: Quantile-based trimming with default \code{c(0.01, 0.99)}
\item \code{"absolute"}: Explicit absolute bounds with default \code{c(0.01, 0.99)}
\item A numeric vector of length 2: \code{c(lower, upper)} absolute bounds
\item A single numeric: Symmetric bounds \code{c(x, 1-x)}
\item A list with \code{method} ("absolute"/"quantile"/"none") and \code{bounds}
}}

\item{...}{Additional arguments passed to internal functions.}
}
\value{
An object of class \code{c("cf_calibration", "cf_performance")} containing:
\item{predicted}{Vector of predicted probabilities}
\item{observed}{Vector of smoothed observed probabilities}
\item{smoother}{Smoothing method used}
\item{ici}{Integrated calibration index}
\item{e50}{Median absolute calibration error}
\item{e90}{90th percentile absolute calibration error}
\item{emax}{Maximum absolute calibration error}
\item{se}{List of standard errors (if se_method = "bootstrap")}
\item{ci_lower}{List of lower CI bounds (if se_method = "bootstrap")}
\item{ci_upper}{List of upper CI bounds (if se_method = "bootstrap")}
\item{boot_curves}{Bootstrap calibration curves for CI bands (if se_method = "bootstrap")}
}
\description{
Estimates the calibration curve of a prediction model under a hypothetical
intervention where treatment is set to a specific level.
}
\details{
The counterfactual calibration curve estimates the relationship between
predicted risk and observed risk under the counterfactual intervention.

The function implements three estimators:

\strong{IPW Estimator}: Weights observations by the inverse probability of
receiving the counterfactual treatment. Requires a correctly specified
propensity score model.

\strong{Conditional Loss (CL) Estimator}: Uses the fitted outcome model
\eqn{E[Y | X, A=a]} to estimate calibration over all observations. Requires a
correctly specified outcome model.

\strong{Doubly Robust (DR) Estimator}: Combines CL and IPW approaches. Consistent
if either the propensity or outcome model is correctly specified.
}
\examples{
# Generate example data
set.seed(123)
n <- 500
x <- rnorm(n)
a <- rbinom(n, 1, plogis(-0.5 + 0.5 * x))
y <- rbinom(n, 1, plogis(-1 + x - 0.5 * a))
pred <- plogis(-1 + 0.8 * x)

# Estimate counterfactual calibration curve with different estimators
result_ipw <- cf_calibration(
  predictions = pred,
  outcomes = y,
  treatment = a,
  covariates = data.frame(x = x),
  treatment_level = 0,
  estimator = "ipw"
)

result_dr <- cf_calibration(
  predictions = pred,
  outcomes = y,
  treatment = a,
  covariates = data.frame(x = x),
  treatment_level = 0,
  estimator = "dr"
)
print(result_dr)
# plot(result_dr)  # If ggplot2 is available

# With bootstrap confidence bands
# result_boot <- cf_calibration(
#   predictions = pred, outcomes = y, treatment = a,
#   covariates = data.frame(x = x), treatment_level = 0,
#   se_method = "bootstrap", n_boot = 200
# )
# plot(result_boot)  # Shows confidence bands
}
\references{
Boyer, C. B., Dahabreh, I. J., & Steingrimsson, J. A. (2025).
"Estimating and evaluating counterfactual prediction models."
\emph{Statistics in Medicine}, 44(23-24), e70287. \doi{10.1002/sim.70287}

Steingrimsson, J. A., Gatsonis, C., Li, B., & Dahabreh, I. J. (2023).
"Transporting a prediction model for use in a new target population."
\emph{American Journal of Epidemiology}, 192(2), 296-304.
}
\seealso{
\code{\link[=cf_mse]{cf_mse()}}, \code{\link[=cf_auc]{cf_auc()}}, \code{\link[=plot.cf_calibration]{plot.cf_calibration()}}
}
