% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/tr_calibration.R
\name{tr_calibration}
\alias{tr_calibration}
\title{Estimate (Counterfactual) Calibration in the Target Population}
\usage{
tr_calibration(
  predictions,
  outcomes,
  treatment,
  source,
  covariates,
  treatment_level = 0,
  analysis = c("transport", "joint"),
  estimator = c("dr", "ipw", "om"),
  selection_model = NULL,
  propensity_model = NULL,
  outcome_model = NULL,
  smoother = c("loess", "binned"),
  n_bins = 10,
  span = 0.75,
  se_method = c("none", "bootstrap"),
  n_boot = 200,
  conf_level = 0.95,
  stratified_boot = TRUE,
  ...
)
}
\arguments{
\item{predictions}{Numeric vector of model predictions (typically probabilities).}

\item{outcomes}{Numeric vector of observed outcomes (must be binary 0/1).}

\item{treatment}{Numeric vector of treatment indicators (0/1).}

\item{source}{Numeric vector of population indicators (1=source/RCT, 0=target).}

\item{covariates}{A matrix or data frame of baseline covariates.}

\item{treatment_level}{The treatment level of interest (default: 0).}

\item{analysis}{Character string specifying the type of analysis:
\itemize{
\item \code{"transport"}: Use source outcomes for target estimation (default)
\item \code{"joint"}: Pool source and target data
}}

\item{estimator}{Character string specifying the estimator:
\itemize{
\item \code{"dr"}: Doubly robust estimator (default)
\item \code{"ipw"}: Inverse probability weighting estimator
\item \code{"om"}: Outcome model estimator
}}

\item{selection_model}{Optional fitted selection model for P(S=0|X). If NULL,
a logistic regression model is fit using the covariates.}

\item{propensity_model}{Optional fitted propensity score model for P(A=1|X,S=1).
If NULL, a logistic regression model is fit using source data.}

\item{outcome_model}{Optional fitted outcome model for E[Y|X,A,S].
If NULL, a regression model is fit using the relevant data.}

\item{smoother}{Smoothing method for the calibration curve:
\itemize{
\item \code{"loess"}: Local polynomial regression (default)
\item \code{"binned"}: Binned calibration
}}

\item{n_bins}{Number of bins for binned calibration (default: 10).}

\item{span}{Span parameter for LOESS smoothing (default: 0.75).}

\item{se_method}{Method for standard error estimation:
\itemize{
\item \code{"none"}: No standard error estimation (default, fastest)
\item \code{"bootstrap"}: Bootstrap standard errors
}}

\item{n_boot}{Number of bootstrap replications (default: 200).}

\item{conf_level}{Confidence level for intervals (default: 0.95).}

\item{stratified_boot}{Logical indicating whether to use stratified bootstrap
that preserves the source/target ratio (default: TRUE).}

\item{...}{Additional arguments passed to internal functions.}
}
\value{
An object of class \code{c("tr_calibration", "tr_performance")} containing:
\item{predicted}{Vector of predicted probabilities}
\item{observed}{Vector of smoothed observed probabilities}
\item{smoother}{Smoothing method used}
\item{ici}{Integrated calibration index}
\item{e50}{Median absolute calibration error}
\item{e90}{90th percentile absolute calibration error}
\item{emax}{Maximum absolute calibration error}
\item{se}{Named list of standard errors for calibration metrics (if computed)}
\item{ci_lower}{Named list of lower confidence bounds}
\item{ci_upper}{Named list of upper confidence bounds}
\item{estimator}{Estimator used}
\item{analysis}{Analysis type}
\item{n_target}{Number of target observations}
\item{n_source}{Number of source observations}
}
\description{
Estimates the calibration of a prediction model in a target population
using data transported from a source population (typically an RCT).
}
\details{
This function implements estimators for transporting prediction model
calibration from a source population (typically an RCT) to a target
population.

\strong{Transportability Analysis}: Uses outcome data from the source/RCT
population to estimate calibration in the target population. The IPW
estimator weights source observations to represent the target population.

\strong{Joint Analysis}: Pools source and target data to estimate calibration
in the target population.

The function computes several calibration metrics:
\itemize{
\item \strong{ICI} (Integrated Calibration Index): Mean absolute difference between
predicted and observed probabilities
\item \strong{E50}: Median absolute calibration error
\item \strong{E90}: 90th percentile absolute calibration error
\item \strong{Emax}: Maximum absolute calibration error
}

For observational analysis (single population), use \code{\link[=cf_calibration]{cf_calibration()}} instead.
}
\examples{
# Generate example data with source (RCT) and target populations
set.seed(123)
n <- 1000
# Covariates
x <- rnorm(n)
# Source indicator (S=1 for RCT, S=0 for target)
s <- rbinom(n, 1, plogis(0.5 - 0.3 * x))
# Treatment (randomized in source, confounded in target)
a <- ifelse(s == 1,
            rbinom(n, 1, 0.5),  # Randomized in RCT
            rbinom(n, 1, plogis(-0.5 + 0.5 * x)))  # Confounded in target
# Outcome (binary)
y <- rbinom(n, 1, plogis(-1 + x - 0.5 * a))
# Prediction model
pred <- plogis(-1 + 0.8 * x)

# Estimate transportable calibration with IPW
result <- tr_calibration(
  predictions = pred,
  outcomes = y,
  treatment = a,
  source = s,
  covariates = data.frame(x = x),
  treatment_level = 0,
  analysis = "transport",
  estimator = "ipw",
  se_method = "none"  # Use "bootstrap" for SEs
)
print(result)
}
\references{
Voter, S. R., et al. (2025). "Transportability of machine learning-based
counterfactual prediction models with application to CASS."
\emph{Diagnostic and Prognostic Research}, 9(4).
\doi{10.1186/s41512-025-00201-y}

Austin, P. C., & Steyerberg, E. W. (2019). "The Integrated Calibration
Index (ICI) and related metrics for quantifying the calibration of
logistic regression models."
\emph{Statistics in Medicine}, 38(21), 4051-4065.
}
\seealso{
\code{\link[=cf_calibration]{cf_calibration()}}, \code{\link[=tr_mse]{tr_mse()}}, \code{\link[=tr_auc]{tr_auc()}}, \code{\link[=plot.tr_calibration]{plot.tr_calibration()}}
}
